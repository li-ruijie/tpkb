name: Build and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 2.8.1)'
        required: true
        type: string

permissions: {}

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set version
        shell: pwsh
        run: |
          $version = "${{ inputs.version }}"
          $parts = $version.Split('.')
          $comma = ($parts + @('0') * 4)[0..3] -join ','
          $dot = ($parts + @('0') * 4)[0..3] -join '.'

          Write-Host "Setting version to $version (file version: $dot)"

          # Update PROGRAM_VERSION in src/types.h
          $types = Get-Content "src/types.h" -Raw
          $types = $types -replace '#define PROGRAM_VERSION\s+L"[^"]*"', "#define PROGRAM_VERSION   L`"$version`""
          Set-Content "src/types.h" $types -NoNewline

          # Update VERSIONINFO in res/w10wheel.rc
          $rc = Get-Content "res/w10wheel.rc" -Raw
          $rc = $rc -replace 'FILEVERSION\s+\d+,\d+,\d+,\d+', "FILEVERSION    $comma"
          $rc = $rc -replace 'PRODUCTVERSION\s+\d+,\d+,\d+,\d+', "PRODUCTVERSION $comma"
          $rc = $rc -replace '"FileVersion",\s*"[^"]*"', "`"FileVersion`", `"$dot`""
          $rc = $rc -replace '"ProductVersion",\s*"[^"]*"', "`"ProductVersion`", `"$dot`""
          Set-Content "res/w10wheel.rc" $rc -NoNewline

          echo "VERSION=$version" >> $env:GITHUB_ENV

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@0b201ec74fa43914dc39ae48a89fd1d8cb592756 # v1

      - name: Build
        run: |
          cmake -B build -G "NMake Makefiles" -DCMAKE_BUILD_TYPE=Release
          cmake --build build

      - name: Commit version
        shell: pwsh
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add src/types.h res/w10wheel.rc
          $status = git status --porcelain
          if ($status) {
            git commit -m "Release v$env:VERSION"
            git push
          }

      - name: Prepare release files
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist
          Copy-Item "build/W10Wheel.exe" "dist/"
          Copy-Item "LICENSE.txt" "dist/"
          Copy-Item "README.md" "dist/"
          Compress-Archive -Path "dist/*" -DestinationPath "W10Wheel-v${{ env.VERSION }}.zip"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          tag_name: v${{ env.VERSION }}
          name: W10Wheel v${{ env.VERSION }}
          body: |
            ## W10Wheel v${{ env.VERSION }}

            ## Installation

            1. Extract the zip file to any folder
            2. Run `W10Wheel.exe`
            3. The app runs in the system tray

            ## Requirements

            - Windows 10/11
          files: W10Wheel-v${{ env.VERSION }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: W10Wheel-v${{ env.VERSION }}
          path: build/W10Wheel.exe
